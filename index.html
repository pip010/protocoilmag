<!DOCTYPE html>
<html>
    <head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>DeNaCoR :: ProtoMag v0.2</title>
		<!--[if lt IE 9]>
			<script src="js/excanvas.js"></script>
		<![endif]-->
        
        <script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="js/three.min.js"></script>
		<script type="text/javascript" src="js/TrackballControls.js"></script>
		<script type="text/javascript" src="js/numeric-1.2.6.min.js"></script>
		<script type="text/javascript" src="js/dat.gui.min.js"></script>
		<!--<script type="text/javascript" src="js/requestAnimation.js"></script>-->
		
		<!-- NAMESPACES IN JS -->
		<script type="text/javascript" src="js/ns.js"></script>
		
		<!-- SIMULATOR -->
		<script type="text/javascript" src="PCM.Sim.js"></script>
		
		<!-- CSS -->
		<link rel=stylesheet href="css/jquery-ui.css" />		
		<link rel=stylesheet href="css/main.css" />

    </head>
    <body>
	<script type="text/javascript" >
		
		//holly Pi
		pi = Math.atan(1)*4;
		
		//canvas = document.getElementById("canvas");
		//scene = new THREE.Scene();
		
		var model = 
		{
			camera :
			{
				type : 0
			},
			domain :
			{
				dimension : 7,
				stepx : 1.0,
				stepy : 1.0,
				stepz : 0.6
			},
			coil:
			{			
				loops : 1,
				segments : 12
			},
			field:
			{
				type: 0,
				normalized: true,
				cutter: 0
			},
			colormap : 
			{
				cc1: "#ffae23"
			},
			
			ForceDisableWebGL : false,
			

			ResetCamera : function() 
			{
				RunVisualization(this);
			},
			Simulate : function() 
			{ 
				RunSimulation(this);
				RunVisualization(this);
			},
			Visualize : function()
			{
				RunVisualization(this);
			}
			
			//this.color0 = "#ffae23"; // CSS string
			//this.color1 = [ 0, 128, 255 ]; // RGB array
			//this.color2 = [ 0, 128, 255, 0.3 ]; // RGB with alpha
			//this.color3 = { h: 350, s: 0.9, v: 0.3 }; // Hue, saturation, value

		};
		
		$(document).ready(function(){

			console.log(' Page Loaded ');
			
			loadGUI(model);
			
			$('#divHelloWorld').fadeIn(4000);

		});

		function setProgress(progress)
		{           
			var progressBarWidth =progress*$("#progressbar_container").width()/ 100;  
			$("#progressbar").width(progressBarWidth).html(progress + "% ");
		}
	
		function loadGUI( model)
		{		
			gui = new dat.GUI();//{load:model,preset:"Default"});
			
			
			//GUI TAB: Camera
			var guiTabCamera = gui.addFolder('Camera');
			guiTabCamera.add(model.camera, 'type', { Orthogonal: 0, Perspective : 1 }).name("Type");
			guiTabCamera.add(model, 'ForceDisableWebGL').name("Force NO WebGL");
			
			//GUI TAB: Domian Model
			var guiTabDomain = gui.addFolder('Domain');
			var guiDN = guiTabDomain.add( model.domain, 'dimension' ).min(7).max(50).step(1.0).name("Dimension");
			guiDN.onChange( function(value) { 
				guiFC.max(value);
			});
			guiTabDomain.add( model.domain, 'stepx' ).min(0.1).max(10).step(1).name("Spacing X");
			guiTabDomain.add( model.domain, 'stepy' ).min(0.1).max(10).step(1).name("Spacing Y");
			guiTabDomain.add( model.domain, 'stepz' ).min(0.1).max(10).step(1).name("Spacing Z");


			//GUI TAB : Coil Model
			var guiTabCoil = gui.addFolder('Coil');
			guiTabCoil.add( model.coil, 'loops' ).min(1).max(1000).step(10).name("Wire Loops");
			guiTabCoil.add( model.coil, 'segments' ).min(12).max(48).step(1).name("Circle Segments");
			
			//GUI TAB : Field Modify
			var guiTabField= gui.addFolder('Field');
			guiTabField.add(model.field, 'type', { Cones: 0, Arrows : 1, Spheres : 2 }).name("Type");			
			var guiFN= guiTabField.add( model.field, 'normalized' ).name("Normalized").listen();
			var guiFC = guiTabField.add( model.field, 'cutter' ).min(0).max(16).step(1).name("Cut On Z").listen();
			guiFC.onChange( function(value) { 
				Visualize();
			});
			
			//GUI TAB : Color Map
			var guiTabColorMap = gui.addFolder('Color Map');
			guiTabColorMap.addColor( model.colormap, 'cc1' ).name("Control Color 1");
			
			// GUI BUTTONS:
			gui.add( model, 'ResetCamera' ).name("Reset Camera");
			gui.add( model, 'Simulate' ).name("Simulate");
			
			//gui.remember(model);
			//gui.remember(model.camera);
			//gui.remember(model.domain);
			//gui.remember(model.field);
			//gui.revert();
		}
		
		function RunSimulation(model)
		{

			ProtoMag.Sim({
				dim : Math.ceil(model.domain.dimension), 
				loops : Math.ceil(model.coil.loops),
				segs : Math.ceil(model.coil.segments),
				stepx : model.domain.stepx, 
				stepy : model.domain.stepy, 
				stepz : model.domain.stepz,
				});
		}


		function RunVisualization(model)
		{
			var canvasElement = document.getElementById("canvas");
			

			var scene = new THREE.Scene();

			var camera = null;
			if(model.camera.type == 0)
				camera = new THREE.OrthographicCamera( -5, 5, 5, -5, 0.1, 1000 );
			else
				camera = new THREE.PerspectiveCamera( 75, canvasElement.clientWidth / canvasElement.clientHeight, 0.1, 100 );

			camera.position.x = 0;
			camera.position.y = 0;
			camera.position.z = 15;
			
			var renderer = null;
			if (window.WebGLRenderingContext && !model.ForceDisableWebGL)
			{
				renderer = new THREE.WebGLRenderer({canvas:canvasElement});
			}
			else
			{
				renderer = new THREE.CanvasRenderer({canvas:canvasElement});		
			}
			renderer.setSize( canvasElement.clientWidth, canvasElement.clientHeight );
			
			var mesh = ProtoMag.Mesh;
			var UVW = ProtoMag.VectorField;
			var coil = ProtoMag.CoildMesh;

			if(mesh === undefined || UVW === undefined)
			{
				ProtoMag.log('cannot run visualization, run simulation first');
				return;
			}

			var rootNode = new THREE.Object3D();
			
			//show field
			ProtoMag.showVectorField(
							rootNode,
							model.field.type,
							model.field.normalized,
							mesh,
							UVW,
							model.field.cutter);
				
			//show coil
			ProtoMag.showLineSegments(rootNode,coil);
			
			//ProtoMag.root = rootNode;	
			scene.add(rootNode);
			
			
			//http://threejs.org/examples/misc_controls_trackball.html
			var controls = new THREE.TrackballControls(camera,renderer.domElement);
			controls.rotateSpeed = 1.0;
			controls.zoomSpeed = 1.2;
			controls.panSpeed = 0.8;
			controls.noZoom = false;
			controls.noPan = false;
			controls.staticMoving = true;
			controls.dynamicDampingFactor = 0.3;
			controls.keys = [ 65, 83, 68 ];
			//controls.addEventListener( 'change', Render );
			
			ProtoMag.controls = controls;
			
			
			//Render Scene			
			ProtoMag.renderer = renderer;
			ProtoMag.camera = camera;
			ProtoMag.scene = scene;			
			Animate();
		}
		
		function Animate()
		{
			Render();
			requestAnimationFrame(Animate);
		}
		
		function Render()
		{
			ProtoMag.renderer.render(ProtoMag.scene, ProtoMag.camera);
			ProtoMag.controls.update();
		}

	</script>

		<header>
			<div id="divHelloWorld">Welcome to ProtoMag</div>
			<div id="progressbar_container"><div id="progressbar"></div></div>		
        </header>

       <canvas id="canvas" width="800" height="600"></canvas>


		<footer>
		Copyright 2013 Petar Petrov (www.ppetrov.net)
		</footer>
    </body>
</html>
